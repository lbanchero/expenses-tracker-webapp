<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Expense Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0B1F17">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="application-name" content="Expense Tracker">
    <meta name="msapplication-TileColor" content="#1F2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Expense Tracker">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="./icons/favicon.ico" sizes="16x16 32x32" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10B981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        secondary: {
                            50: '#e6f7f2',
                            100: '#ccefe5',
                            200: '#99dfcc',
                            300: '#66cfb2',
                            400: '#33bf99',
                            500: '#0EA971',
                            600: '#0b8a5b',
                            700: '#086c46',
                            800: '#064d31',
                            900: '#032f1d',
                        },
                        accent: {
                            green: '#10B981',
                            teal: '#14B8A6',
                            orange: '#F59E0B',
                            red: '#EF4444',
                        },
                        dark: {
                            bg: '#0B1F17',
                            surface: '#112720',
                            card: '#163229',
                            border: '#1f3d33',
                            text: '#FFFFFF',
                            muted: '#A1B5AE',
                        },
                        glass: {
                            bg: 'rgba(255, 255, 255, 0.05)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        }
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-subtle': 'bounceSubtle 0.6s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-2px)' },
                        },
                    }
                }
            }
        }
    </script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // Expose Vite env vars to the window for inline scripts
        window.__ENV__ = {
            SUPABASE_URL: import.meta.env.VITE_SUPABASE_URL,
            SUPABASE_ANON_KEY: import.meta.env.VITE_SUPABASE_ANON_KEY,
        };
    </script>
    
    <style>
        /* Import SF Pro Display font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        /* Root variables */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --primary-glow: rgba(16, 185, 129, 0.4);
            --secondary-glow: rgba(20, 184, 166, 0.4);
        }
        
        /* Base styles */
        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0B1F17 0%, #112720 50%, #0B1F17 100%);
            background-attachment: fixed;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Glassmorphism effects */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }
        
        .glass-card {
            background: rgba(38, 38, 38, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }
        /* Hero card specific transitions and shadow */
        .hero-card {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
            overflow: visible;
        }

        .hero-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.45);
        }
        
        /* Safe area support for iOS notch */
        .safe-area-pad {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Modern loading spinner */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-top: 2px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Button hover effects */
        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
            box-shadow: 0 4px 15px 0 rgba(16, 185, 129, 0.3);
            transform: translateY(0);
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
            box-shadow: 0 4px 15px 0 rgba(16, 185, 129, 0.3);
            transform: translateY(0);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }
        
        /* Card hover effects */
        .card-hover {
            transform: none;
            transition: none;
        }
        
        .card-hover:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #10B981 0%, #34D399 50%, #14B8A6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Floating animation */
        .float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Pulse glow effect */
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
            to {
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            }
        }
        
        /* Enhanced focus states */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }
        
        /* Slide up animation for modals */
        .slide-up-enter {
            transform: translateY(100%);
            opacity: 0;
        }
        
        .slide-up-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Number counter animation */
        .counter {
            font-variant-numeric: tabular-nums;
            font-feature-settings: 'tnum';
        }
        
        /* Modern input styles */
        .input-modern {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .input-modern:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Category icons */
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* Swipe indicator */
        .swipe-indicator {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .swipe-item:hover .swipe-indicator {
            opacity: 1;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Responsive text scaling */
        @media (max-width: 640px) {
            .text-responsive-lg {
                font-size: 2rem;
                line-height: 2.25rem;
            }
        }
        
        @media (min-width: 641px) {
            .text-responsive-lg {
                font-size: 3rem;
                line-height: 3.5rem;
            }
        }
        
        /* Modern navigation patterns */
        .nav-tab {
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .nav-tab:hover::before {
            left: 100%;
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus visible for keyboard navigation */
        .focus-visible:focus-visible {
            outline: 2px solid #10B981;
            outline-offset: 2px;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .glass-card {
                border: 2px solid rgba(255, 255, 255, 0.3);
            }
            
            .btn-primary, .btn-secondary {
                border: 2px solid currentColor;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .card-hover:hover {
                transform: none;
            }
            
            .btn-primary:hover, .btn-secondary:hover {
                transform: none;
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text min-h-screen">
    <div id="root"></div>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    
    <!-- Main App Script -->
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        
        // Configuration - read from Vite-provided env (set in .env.local)
        const SUPABASE_URL = (window.__ENV__ && window.__ENV__.SUPABASE_URL) || '';
        const SUPABASE_ANON_KEY = (window.__ENV__ && window.__ENV__.SUPABASE_ANON_KEY) || '';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Auth Context
        const AuthContext = createContext();
        
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                // Get initial session
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setLoading(false);
                });
                
                // Listen for auth changes
                const { data: { subscription } } = supabase.auth.onAuthStateChange(
                    (event, session) => {
                        setUser(session?.user ?? null);
                        setLoading(false);
                    }
                );
                
                return () => subscription.unsubscribe();
            }, []);
            
            const signInWithGoogle = async () => {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                if (error) console.error('Error signing in:', error);
            };
            
            const signOut = async () => {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                } catch (err) {
                    console.error('Error signing out:', err);
                } finally {
                    setUser(null);
                    // Ensure full UI reset on mobile/PWA
                    const target = window.location.origin + window.location.pathname;
                    window.location.replace(target);
                }
            };
            
            return (
                <AuthContext.Provider value={{ user, loading, signInWithGoogle, signOut }}>
                    {children}
                </AuthContext.Provider>
            );
        };
        
        const useAuth = () => {
            const context = useContext(AuthContext);
            if (!context) {
                throw new Error('useAuth must be used within an AuthProvider');
            }
            return context;
        };
        
        // Utility functions
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        };
        
        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };
        
        const getCurrentMonthRange = () => {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            return { start, end };
        };
        
        // Components
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-4">
                <div className="loading-spinner"></div>
            </div>
        );
        
        const SignInScreen = () => {
            const { signInWithGoogle } = useAuth();
            
            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
                    {/* Background gradient orbs */}
                    <div className="absolute top-20 left-10 w-32 h-32 bg-primary-500 rounded-full opacity-20 blur-3xl animate-pulse-slow"></div>
                    <div className="absolute bottom-20 right-10 w-40 h-40 bg-secondary-500 rounded-full opacity-20 blur-3xl animate-pulse-slow" style={{animationDelay: '1s'}}></div>
                    
                    <div className="glass-card rounded-2xl p-8 w-full max-w-md text-center animate-fade-in relative z-10">
                        <div className="mb-10">
                            <div className="w-20 h-20 bg-gradient-to-br from-primary-500 via-primary-400 to-secondary-500 rounded-2xl mx-auto mb-6 flex items-center justify-center pulse-glow float overflow-hidden">
                                <img src={new URL('./icons/icon-192.png', window.location.origin).toString()} alt="App icon" className="w-12 h-12" onError={(e)=>{e.currentTarget.style.display='none';}} />
                            </div>
                            <h1 className="text-3xl font-bold gradient-text mb-3">Expense Tracker</h1>
                            <p className="text-dark-muted text-lg">Your smart financial companion</p>
                        </div>
                        
                        <button
                            onClick={signInWithGoogle}
                            className="w-full bg-white text-gray-800 font-semibold py-4 px-6 rounded-xl hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:scale-105"
                        >
                            <svg className="w-6 h-6" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </button>
                        
                        <p className="text-xs text-dark-muted mt-6 opacity-75">
                            Secure authentication powered by Google
                        </p>
                    </div>
                </div>
            );
        };
        
        const Header = ({ title, onBack, actions }) => (
            <header className="glass-card border-b border-dark-border p-4 pt-[env(safe-area-inset-top)] sticky top-0 z-20 backdrop-blur-xl safe-area-pad">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        {onBack && (
                            <button
                                onClick={onBack}
                                className="p-2 hover:bg-glass-bg rounded-xl transition-all duration-200 hover:scale-105"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                        )}
                        <img src="/icons/icon-192.png" alt="Expense Tracker" className="w-6 h-6 rounded-lg" />
                    </div>
                    {actions && <div className="flex items-center gap-2">{actions}</div>}
                </div>
            </header>
        );

        const TransactionItem = ({ transaction, onEdit, onDelete }) => {
            return (
                <div className="glass-card rounded-xl p-3 mb-2 card-hover swipe-item relative animate-fade-in">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-dark-muted rounded-lg flex items-center justify-center">
                            <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                            </svg>
                        </div>
                        <div className="flex-1">
                            <p className="font-medium text-dark-text text-sm">{transaction.description}</p>
                            <p className="text-xs text-dark-muted">
                                {formatDate(transaction.transaction_date)}
                            </p>
                        </div>
                        <div className="text-right">
                            <p className="font-semibold text-sm text-accent-red counter">
                                -{formatCurrency(transaction.amount)}
                            </p>
                            <div className="flex gap-2 mt-1">
                                <button
                                    onClick={() => onEdit(transaction)}
                                    className="text-xs text-primary-500 hover:text-primary-400 transition-colors font-medium px-1 py-0.5 rounded hover:bg-glass-bg"
                                >
                                    Edit
                                </button>
                                <button
                                    onClick={() => onDelete(transaction.id)}
                                    className="text-xs text-accent-red hover:text-red-300 transition-colors font-medium px-1 py-0.5 rounded hover:bg-glass-bg"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="swipe-indicator">
                        <svg className="w-3 h-3 text-dark-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
            );
        };
        
        const ExpenseForm = ({ onSubmit, onCancel, initialData = null }) => {
            const [amount, setAmount] = useState(initialData?.amount || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [date, setDate] = useState(
                initialData?.transaction_date || new Date().toISOString().split('T')[0]
            );
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!amount || !description || !date) return;
                
                setLoading(true);
                try {
                    await onSubmit({
                        amount: parseFloat(amount),
                        description,
                        transaction_date: date
                    });
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-end justify-center z-50 animate-fade-in">
                    <div className="glass-card w-full max-w-md rounded-t-3xl p-6 pb-8 animate-slide-up relative safe-area-pad">
                        {/* Drag handle */}
                        <div className="w-12 h-1 bg-dark-muted rounded-full mx-auto mb-6 opacity-50"></div>
                        
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h2 className="text-2xl font-bold gradient-text">
                                    {initialData ? 'Edit Expense' : 'Add Expense'}
                                </h2>
                                <p className="text-dark-muted text-sm mt-1">
                                    {initialData ? 'Update your expense details' : 'Track your spending'}
                                </p>
                            </div>
                            <button
                                onClick={onCancel}
                                className="p-3 hover:bg-glass-bg rounded-2xl transition-all duration-200 hover:scale-105"
                            >
                                <svg className="w-6 h-6 text-dark-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-semibold text-dark-text mb-3">
                                    Amount (EUR)
                                </label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-dark-muted">
                                        â‚¬
                                    </div>
                                    <input
                                        type="text"
                                        inputMode="decimal"
                                        pattern="[0-9]*[.,]?[0-9]*"
                                        value={amount}
                                        onChange={(e) => setAmount(e.target.value)}
                                        className="w-full input-modern rounded-2xl pl-10 pr-4 py-4 text-dark-text text-lg font-semibold focus-ring placeholder-dark-muted"
                                        placeholder="0.00"
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold text-dark-text mb-3">
                                    Description
                                </label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-dark-muted">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                        </svg>
                                    </div>
                                    <input
                                        type="text"
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        className="w-full input-modern rounded-2xl pl-12 pr-4 py-4 text-dark-text focus-ring placeholder-dark-muted"
                                        placeholder="What did you spend on?"
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold text-dark-text mb-3">
                                    Date
                                </label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-dark-muted">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <input
                                        type="date"
                                        value={date}
                                        onChange={(e) => setDate(e.target.value)}
                                        className="w-full input-modern rounded-2xl pl-12 pr-4 py-4 text-dark-text focus-ring"
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="flex gap-4 pt-4 pb-[calc(env(safe-area-inset-bottom)_+_8px)]">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 glass-card hover:bg-glass-bg text-dark-text font-semibold py-3 px-5 rounded-2xl transition-all duration-300 hover:scale-105"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 btn-primary text-white font-bold py-3 px-5 rounded-2xl disabled:opacity-50 flex items-center justify-center gap-3"
                                >
                                    {loading && <div className="loading-spinner"></div>}
                                    <span>{initialData ? 'Update' : 'Add'} Expense</span>
                                    {!loading && (
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const Dashboard = () => {
            const { user, signOut } = useAuth();
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [monthlyTotal, setMonthlyTotal] = useState(0);
            const [showPastMonths, setShowPastMonths] = useState(false);
            
            const loadTransactions = async () => {
                try {
                    const { start, end } = getCurrentMonthRange();
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .gte('transaction_date', start.toISOString().split('T')[0])
                        .lte('transaction_date', end.toISOString().split('T')[0])
                        .order('transaction_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    setTransactions(data || []);
                    const total = (data || []).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                    setMonthlyTotal(total);
                } catch (error) {
                    console.error('Error loading transactions:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => {
                if (user) {
                    loadTransactions();
                }
            }, [user]);
            
            const handleAddExpense = async (expenseData) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .insert([{ ...expenseData, user_id: user.id }]);
                    
                    if (error) throw error;
                    
                    setShowForm(false);
                    loadTransactions();
                } catch (error) {
                    console.error('Error adding expense:', error);
                    alert('Error adding expense. Please try again.');
                }
            };
            
            const handleEditExpense = async (expenseData) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .update(expenseData)
                        .eq('id', editingTransaction.id);
                    
                    if (error) throw error;
                    
                    setEditingTransaction(null);
                    loadTransactions();
                } catch (error) {
                    console.error('Error updating expense:', error);
                    alert('Error updating expense. Please try again.');
                }
            };
            
            const handleDeleteExpense = async (id) => {
                if (!confirm('Are you sure you want to delete this expense?')) return;
                
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    loadTransactions();
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    alert('Error deleting expense. Please try again.');
                }
            };
            
            if (showPastMonths) {
                return <PastMonthsView onBack={() => setShowPastMonths(false)} />;
            }
            
            return (
                <div className="min-h-screen bg-dark-bg pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)]">
                    {/* Hero Balance Card */}
                    <div className="p-6">
                        <div className="flex justify-end mb-4">
                            <button
                                onClick={signOut}
                                className="text-sm glass-card hover:bg-glass-bg text-white font-medium py-2 px-3 rounded-xl transition-all flex items-center gap-2"
                            >
                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1" />
                                </svg>
                                Sign out
                            </button>
                        </div>
                        <div className="relative overflow-visible">
                            {/* Background gradient orbs */}
                            <div className="absolute -top-10 -right-10 w-32 h-32 bg-primary-500 rounded-full opacity-30 blur-2xl"></div>
                            <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-secondary-500 rounded-full opacity-20 blur-2xl"></div>
                            
                            <div className="glass-card hero-card rounded-3xl p-8 mb-8 relative z-10 animate-fade-in">
                                <div className="flex items-center justify-between mb-6">
                                    <div>
                                        <p className="text-dark-muted text-sm font-medium mb-1">Total Spent</p>
                                        <h2 className="text-dark-text text-lg font-semibold">
                                            {new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </h2>
                                    </div>
                                    <div className="w-12 h-12 bg-gradient-to-br from-primary-500 to-secondary-500 rounded-2xl flex items-center justify-center">
                                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                        </svg>
                                    </div>
                                </div>
                                
                                <div className="mb-4 text-center">
                                    <p className="text-sm text-dark-muted mb-1">
                                        {(() => {
                                            const fullName = (user && (user.user_metadata?.full_name || user.user_metadata?.name)) || '';
                                            const firstName = fullName ? fullName.split(' ')[0] : (user?.email || '');
                                            return `Hello ${firstName}, your monthly spending is`;
                                        })()}
                                    </p>
                                    <p className="text-responsive-lg font-bold text-secondary-500 counter mb-2">
                                        {formatCurrency(monthlyTotal)}
                                    </p>
                                    <div className="flex items-center justify-center gap-2">
                                        <div className="flex items-center gap-1 text-primary-400 text-sm">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                            </svg>
                                            <span className="font-medium">{transactions.length} transactions</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Quick Stats */}
                                <div className="grid grid-cols-2 gap-4 pt-4 border-t border-glass-border">
                                    <div className="text-center">
                                        <p className="text-dark-muted text-xs font-medium mb-1">Avg per day</p>
                                        <p className="text-dark-text font-semibold">
                                            {formatCurrency(monthlyTotal / new Date().getDate())}
                                        </p>
                                    </div>
                                    <div className="text-center">
                                        <p className="text-dark-muted text-xs font-medium mb-1">Last expense</p>
                                        <p className="text-dark-text font-semibold">
                                            {transactions.length > 0 ? formatDate(transactions[0].transaction_date) : 'None'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="flex gap-4 mb-8">
                            <button
                                onClick={() => setShowForm(true)}
                                className="flex-1 btn-secondary text-white font-bold py-3 px-5 rounded-2xl flex items-center justify-center gap-3 animate-bounce-subtle"
                            >
                                <div className="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                </div>
                                Add Expense
                            </button>
                            <button
                                onClick={() => setShowPastMonths(true)}
                                className="glass-card hover:bg-glass-bg text-dark-text font-semibold py-3 px-5 rounded-2xl transition-all duration-300 hover:scale-105"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                        </div>
                        
                        {/* Transactions List */}
                        <div>
                            <h3 className="text-lg font-semibold mb-4">Recent Transactions</h3>
                            {loading ? (
                                <LoadingSpinner />
                            ) : transactions.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <svg className="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    <p>No expenses this month</p>
                                    <p className="text-sm mt-1">Tap "Add Expense" to get started</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {transactions.map((transaction) => (
                                        <TransactionItem
                                            key={transaction.id}
                                            transaction={transaction}
                                            onEdit={setEditingTransaction}
                                            onDelete={handleDeleteExpense}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Forms */}
                    {showForm && (
                        <ExpenseForm
                            onSubmit={handleAddExpense}
                            onCancel={() => setShowForm(false)}
                        />
                    )}
                    
                    {editingTransaction && (
                        <ExpenseForm
                            initialData={editingTransaction}
                            onSubmit={handleEditExpense}
                            onCancel={() => setEditingTransaction(null)}
                        />
                    )}
                </div>
            );
        };
        
        const PastMonthsView = ({ onBack }) => {
            const { user } = useAuth();
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedMonth, setSelectedMonth] = useState('');
            const [monthlyTotal, setMonthlyTotal] = useState(0);
            const [showForm, setShowForm] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            
            // Generate month options for the past 12 months
            const getMonthOptions = () => {
                const options = [];
                const now = new Date();
                
                for (let i = 1; i <= 12; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    options.push({ value, label });
                }
                
                return options;
            };
            
            const monthOptions = getMonthOptions();
            
            useEffect(() => {
                if (monthOptions.length > 0 && !selectedMonth) {
                    setSelectedMonth(monthOptions[0].value);
                }
            }, []);
            
            const loadTransactions = async (month) => {
                if (!month) return;
                
                setLoading(true);
                try {
                    const [year, monthNum] = month.split('-');
                    const start = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
                    const end = new Date(parseInt(year), parseInt(monthNum), 0);
                    
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .gte('transaction_date', start.toISOString().split('T')[0])
                        .lte('transaction_date', end.toISOString().split('T')[0])
                        .order('transaction_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    setTransactions(data || []);
                    const total = (data || []).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                    setMonthlyTotal(total);
                } catch (error) {
                    console.error('Error loading transactions:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => {
                if (selectedMonth) {
                    loadTransactions(selectedMonth);
                }
            }, [selectedMonth]);
            
            const handleAddExpense = async (expenseData) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .insert([{
                            ...expenseData,
                            user_id: user.id
                        }]);
                    
                    if (error) throw error;
                    
                    setShowForm(false);
                    loadTransactions(selectedMonth);
                } catch (error) {
                    console.error('Error adding expense:', error);
                    alert('Error adding expense. Please try again.');
                }
            };
            
            const handleEditExpense = async (expenseData) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .update(expenseData)
                        .eq('id', editingTransaction.id);
                    
                    if (error) throw error;
                    
                    setEditingTransaction(null);
                    loadTransactions(selectedMonth);
                } catch (error) {
                    console.error('Error updating expense:', error);
                    alert('Error updating expense. Please try again.');
                }
            };
            
            const handleDeleteExpense = async (id) => {
                if (!confirm('Are you sure you want to delete this expense?')) return;
                
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    loadTransactions(selectedMonth);
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    alert('Error deleting expense. Please try again.');
                }
            };
            
            return (
                <div className="min-h-screen bg-dark-bg">
                    <Header
                        title="Past Months"
                        onBack={onBack}
                        actions={
                            <button
                                onClick={() => setShowForm(true)}
                                className="bg-secondary hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg transition-colors text-sm"
                            >
                                Add
                            </button>
                        }
                    />
                    
                    <div className="p-4">
                        {/* Month Selector */}
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-300 mb-2">
                                Select Month
                            </label>
                            <select
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-dark-text focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                                {monthOptions.map((option) => (
                                    <option key={option.value} value={option.value}>
                                        {option.label}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Monthly Summary */}
                        {selectedMonth && (
                            <div className="bg-gradient-to-r from-primary to-secondary rounded-xl p-6 text-white mb-6">
                                <h2 className="text-lg font-medium opacity-90 mb-2">
                                    {monthOptions.find(opt => opt.value === selectedMonth)?.label}
                                </h2>
                                <p className="text-3xl font-bold">{formatCurrency(monthlyTotal)}</p>
                            </div>
                        )}
                        
                        {/* Transactions List */}
                        <div>
                            <h3 className="text-lg font-semibold mb-4">Transactions</h3>
                            {loading ? (
                                <LoadingSpinner />
                            ) : transactions.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <svg className="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    <p>No expenses this month</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {transactions.map((transaction) => (
                                        <TransactionItem
                                            key={transaction.id}
                                            transaction={transaction}
                                            onEdit={setEditingTransaction}
                                            onDelete={handleDeleteExpense}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Forms */}
                    {showForm && (
                        <ExpenseForm
                            onSubmit={handleAddExpense}
                            onCancel={() => setShowForm(false)}
                        />
                    )}
                    
                    {editingTransaction && (
                        <ExpenseForm
                            initialData={editingTransaction}
                            onSubmit={handleEditExpense}
                            onCancel={() => setEditingTransaction(null)}
                        />
                    )}
                </div>
            );
        };
        
        // Main App Component
        const App = () => {
            const { user, loading } = useAuth();
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-dark-bg flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
            }
            
            return user ? <Dashboard /> : <SignInScreen />;
        };
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>
</html>
